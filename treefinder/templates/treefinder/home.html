{% extends 'treefinder/base.html' %}
{% load static %}

{% block content %}
<p>This is the homepage for FruitFinderTO. Here you can find information about fruit trees in your area.</p>

<form id="searchForm">
    <label for="name">Choose a fruit type:</label>
    <select name="name" id="name">
        <option value="all">All</option>
        <option value="Apple">Apple</option>
        <option value="Cherry">Cherry</option>
        <option value="Mulberry">Mulberry</option>
        <option value="Peach">Peach</option>
        <option value="Pear">Pear</option>
        <option value="Plum">Plum</option>
        <option value="Serviceberry">Serviceberry</option>
    </select>
    <label for="seasonSlider">Select Date:</label>
    <input type="range" id="seasonSlider" name="seasonSlider" min="1" max="365">
    <p>Current Date: <span id="dateDisplay"></span></p>

</form>


<div id="mapid" style="height: 75vh;"></div>

<script type="text/javascript">

    var geocodedAddressLat, geocodedAddressLng;

    document.addEventListener('DOMContentLoaded', function () {

        // Initialize the map
        var mymap = L.map('mapid').setView([43.6415228, -79.4182776], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(mymap);

        var markers = L.markerClusterGroup({
            disableClusteringAtZoom: 17, // Disables clustering at zoom level 17 and beyond
            maxClusterRadius: 120, // The maximum radius that a cluster will cover from the central marker (in pixels)
            spiderfyOnMaxZoom: false, // Don't show spiderfied markers at the highest zoom level
        });

        var today = new Date();
        var start = new Date(today.getFullYear(), 0, 0);
        var diff = today - start;
        var oneDay = 1000 * 60 * 60 * 24;
        var dayOfYear = Math.floor(diff / oneDay);

        document.getElementById('seasonSlider').value = dayOfYear;
        updateDateDisplay(dayOfYear); // Function to update date display below slider

        document.getElementById('seasonSlider').addEventListener('input', function (e) {
            loadVisibleTrees(); // Adjust to filter based on the slider's value
            updateDateDisplay(e.target.value);
        });

        function updateDateDisplay(dayOfYear) {
            // Convert day of the year back to a date
            var date = new Date(new Date().getFullYear(), 0); // Start at Jan 1 this year
            date.setDate(dayOfYear);
            document.getElementById('dateDisplay').innerText = date.toLocaleDateString();
        }

        // Load trees initially Is this necessary?
        //  loadVisibleTrees();

        // Function to load trees within the current map bounds
        function loadVisibleTrees() {
            var bounds = mymap.getBounds();
            var ne = bounds.getNorthEast(); // Northeast corner
            var sw = bounds.getSouthWest(); // Southwest corner
            var name = document.getElementById('name').value;
            var dayOfYear = document.getElementById('seasonSlider').value; // Fetch the day of year from the slider

            var apiUrl = `/api/trees?neLat=${ne.lat}&neLng=${ne.lng}&swLat=${sw.lat}&swLng=${sw.lng}&name=${name}&dayOfYear=${dayOfYear}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    markers.clearLayers();
                    data.forEach(function (tree) {
                        var marker = L.marker([tree.fields.latitude, tree.fields.longitude])
                            .bindPopup(tree.fields.name)
                        markers.addLayer(marker);
                    });
                    mymap.addLayer(markers);
                });
        }

        // Attach event listener to the select dropdown
        document.getElementById('name').addEventListener('change', loadVisibleTrees);

        // Add geocoder
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Search for an address...", // Placeholder text for the input
            collapsed: false, // Ensures that the search bar is always open
            position: 'topright', // Position of the search bar on the map
            geocoder: new L.Control.Geocoder.Nominatim() // Using Nominatim geocoder by default
        }).on('markgeocode', function (e) {
            var bbox = e.geocode.bbox;
            var center = e.geocode.center;
            geocodedAddressLat = center.lat;
            geocodedAddressLng = center.lng;

            // Clear existing markers if necessary
            if (currentMarker) {
                mymap.removeLayer(currentMarker);
            }

            // Add a marker at the geocode result center and open a popup
            var currentMarker = L.marker(center).addTo(mymap)
                .bindPopup(e.geocode.name)
                .openPopup();

            // Continue with your existing functionality to draw a polygon and fit the map bounds
            var poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]).addTo(mymap);
            mymap.fitBounds(poly.getBounds());
        })
            .addTo(mymap);

        // Set up event listeners for when the map stops moving or zooming
        mymap.on('moveend', loadVisibleTrees);
        mymap.on('zoomend', loadVisibleTrees);

    });
</script>

<img src="{% static 'images/MulberryAdventure.png' %}" alt="Mulberry Adventure">
{% endblock content %}