{% extends 'treefinder/base.html' %}
{% load static %}

{% block content %}
<p>This is the homepage for FruitFinderTO. Here you can find information about fruit trees in your area.</p>

<!-- Hidden div to store tree data -->
<div id="treeData" data-trees="{{ trees|safe }}" style="display:none;"></div>

<form id="searchForm">
    <label for="name">Choose a fruit type:</label>
    <select name="name" id="name">
        <option value="all">All</option>
        <option value="Apple">Apple</option>
        <option value="Cherry">Cherry</option>
        <option value="Mulberry">Mulberry</option>
        <option value="Peach">Peach</option>
        <option value="Pear">Pear</option>
        <option value="Plum">Plum</option>
        <option value="Serviceberry">Serviceberry</option>
    </select>
    <label for="inSeason">
        <input type="checkbox" id="inSeason" name="inSeason">
        In Season
    </label>
    <button type="button" onclick="loadVisibleTrees()">Search</button>
</form>


<div id="mapid" style="height: 75vh;"></div>

<script type="text/javascript">
    // console.log('{{ trees|safe }}');  // Check the raw data format
    // Parse the tree data
    var treeData = JSON.parse('{{ trees|escapejs }}');

    // Initialize the map
    var mymap = L.map('mapid').setView([43.6415228, -79.4182776], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(mymap);

    var markers = L.markerClusterGroup({
        disableClusteringAtZoom: 17, // Disables clustering at zoom level 17 and beyond
        maxClusterRadius: 120, // The maximum radius that a cluster will cover from the central marker (in pixels)
        spiderfyOnMaxZoom: false, // Don't show spiderfied markers at the highest zoom level
    });

    // Load trees initially
    loadVisibleTrees();

    // Function to load trees within the current map bounds
    function loadVisibleTrees() {
        var bounds = mymap.getBounds();
        var ne = bounds.getNorthEast(); // Northeast corner
        var sw = bounds.getSouthWest(); // Southwest corner
        var name = document.getElementById('name').value;
        var inSeason = document.getElementById('inSeason').checked;

        var apiUrl = `/api/trees?neLat=${ne.lat}&neLng=${ne.lng}&swLat=${sw.lat}&swLng=${sw.lng}&name=${name}&inSeason=${inSeason}`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                markers.clearLayers();
                data.forEach(function (tree) {
                    var marker = L.marker([tree.fields.latitude, tree.fields.longitude])
                        .bindPopup(tree.fields.name);
                    markers.addLayer(marker);
                });
                mymap.addLayer(markers);
            });
    }

    // Set up event listeners for when the map stops moving or zooming
    mymap.on('moveend', loadVisibleTrees);
    mymap.on('zoomend', loadVisibleTrees);
</script>

<img src="{% static 'images/MulberryAdventure.png' %}" alt="Mulberry Adventure">
{% endblock content %}