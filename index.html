<!DOCTYPE html>
<html>

<head>
    <title>FruitFinderTO - Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Leaflet.markercluster CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.Default.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.css" />

    <!-- Leaflet Fullscreen Plugin CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.5/Control.FullScreen.css" />

    <!-- Leaflet Locate Control CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>

    <!-- Leaflet Control Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" defer></script>

    <!-- Leaflet.markercluster JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/leaflet.markercluster-src.js"
        defer></script>

    <!-- Leaflet Fullscreen Plugin JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.5/Control.FullScreen.js" defer></script>

    <!-- Leaflet Locate Control JS -->
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js" defer></script>

    <style>
        #searchForm {
            margin-bottom: 10px;
        }

        .date-filter-container {
            display: none;
            align-items: center;
            margin-bottom: -10px;
            margin-top: -10px;
        }

        .date-filter-container.flex {
            display: flex;
        }

        #dateDisplay {
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Welcome to FruitFinderTO</h1>
    </header>

    <nav>
        <!-- Navigation links can go here -->
    </nav>

    <p>A map of fruit trees in Toronto. Filter by fruits in season or by type. Search your address to find trees near
        you.</p>

    <form id="searchForm">
        <label for="name">Choose a fruit type:</label>
        <select name="name" id="name">
            <option value="all">All</option>
            <option value="inSeason">In Season</option>
            <option value="Apple">Apple</option>
            <option value="Apricot">Apricot</option>
            <option value="Cherry">Cherry</option>
            <option value="Mulberry">Mulberry</option>
            <option value="Peach">Peach</option>
            <option value="Pear">Pear</option>
            <option value="Plum">Plum</option>
            <option value="Serviceberry">Serviceberry</option>
        </select>
        <div id="dateContainer" class="date-filter-container">
            <label for="seasonSlider">Select Date:</label>
            <input type="range" id="seasonSlider" name="seasonSlider" min="1" max="365">
            <p id="dateDisplay">Current Date: <span></span></p>
        </div>
    </form>

    <div id="mapid" style="height: 75vh;"></div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            // Define an array of coordinate pairs
            var coordinates = [
                [43.64791174084728, -79.4139490884924], // Trinity Bellwoods
                [43.66456705666474, -79.47530041971162], // The Junction
                [43.749421061265046, -79.19145186732189], //Guildwood
                [43.66726436574587, -79.36946540620946], //Cabbagetown
                [43.76468849109555, -79.22306499167108], //Scarborough
                [43.59854688003313, -79.50422801202255], //New Toronto

            ];

            // Select a random coordinate
            var randomIndex = Math.floor(Math.random() * coordinates.length);
            var selectedCoordinate = coordinates[randomIndex];

            // Initialize the map with the selected coordinate
            var mymap = L.map('mapid').setView(selectedCoordinate, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(mymap);

            // Add fullscreen control
            L.control.fullscreen().addTo(mymap);

            // Add locate control with error handling
            L.control.locate({
                flyTo: true,
                keepCurrentZoomLevel: true,
                strings: {
                    title: "Show me where I am",
                    popup: "Your location",
                    outsideMapBoundsMsg: "You seem located outside the boundaries of Toronto",
                    metersUnit: "meters",
                    feetUnit: "feet",
                    popup: "You are within {distance} {unit} from this point"
                },
                locateOptions: {
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            }).addTo(mymap);

            // Handle location errors
            mymap.on('locationerror', function (e) {
                if (e.code === 1) {
                    alert("Geolocation error: User denied Geolocation. Please enable location services in your device settings and browser settings.");
                } else {
                    alert("Geolocation error: " + e.message);
                }
            });

            // Define bounding box coordinates for Toronto
            const TORONTO_BOUNDS = [
                [43.855457, -79.639319], // Northwest corner
                [43.581024, -79.116897]  // Southeast corner
            ];

            // Create a LatLngBounds object for the bounds and set map boundaries
            const torontoBounds = L.latLngBounds(TORONTO_BOUNDS);
            mymap.setMaxBounds(torontoBounds);  // Limit the map to Toronto

            var markers = L.markerClusterGroup({
                disableClusteringAtZoom: 15,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: false,
            });

            var today = new Date();
            var start = new Date(today.getFullYear(), 0, 0);
            var diff = today - start;
            var oneDay = 1000 * 60 * 60 * 24;
            var dayOfYear = Math.floor(diff / oneDay);

            // Set default selection based on date
            if (dayOfYear >= 152 && dayOfYear <= 320) {
                document.getElementById('name').value = 'inSeason';
                document.getElementById('dateContainer').classList.add('flex');
            } else {
                document.getElementById('name').value = 'all';
                document.getElementById('dateContainer').classList.remove('flex');
            }

            document.getElementById('seasonSlider').value = dayOfYear;
            updateDateDisplay(dayOfYear); // Function to update date display below slider

            document.getElementById('seasonSlider').addEventListener('input', function (e) {
                loadVisibleTrees(); // Adjust to filter based on the slider's value
                updateDateDisplay(e.target.value);
            });

            function updateDateDisplay(dayOfYear) {
                var date = new Date(new Date().getFullYear(), 0);
                date.setDate(dayOfYear);
                document.getElementById('dateDisplay').querySelector('span').innerText = date.toLocaleDateString();
            }

            function getColorForTreeType(treeType) {
                switch (treeType) {
                    case 'Apple': return '#FF0000'; // Tomato color
                    case 'Apricot': return '#FFC300'; //saffron
                    case 'Cherry': return '#FF69B4'; // Hot pink
                    case 'Mulberry': return '#8A2BE2'; // Blue violet
                    case 'Peach': return '#FF9966'; // Gold
                    case 'Pear': return '#ADFF2F'; // Green yellow
                    case 'Plum': return '#6A5ACD'; // Slate blue
                    case 'Serviceberry': return '#993333'; // Lime green
                    default: return '#808080'; // Gray
                }
            }

            function loadVisibleTrees() {
                var bounds = mymap.getBounds();
                var ne = bounds.getNorthEast();
                var sw = bounds.getSouthWest();
                var name = document.getElementById('name').value;
                var dayOfYear = document.getElementById('seasonSlider').value;

                fetch("tree_data.json")
                    .then(response => response.json())
                    .then(data => {
                        markers.clearLayers();
                        data.forEach(function (tree) {
                            if (
                                tree.latitude <= ne.lat && tree.latitude >= sw.lat &&
                                tree.longitude <= ne.lng && tree.longitude >= sw.lng &&
                                (name === 'all' || name === 'inSeason' && dayOfYear >= tree.fruiting_start_day && dayOfYear <= tree.fruiting_end_day || tree.name === name)
                            ) {
                                var popupContent = `
                                    <strong>${tree.name} ${tree.sub_name}</strong><br>
                                    Address: ${tree.address}
                                `;
                                var markerColor = getColorForTreeType(tree.name);
                                var marker = L.circleMarker([tree.latitude, tree.longitude], {
                                    radius: 8,
                                    fillColor: markerColor,
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                }).bindPopup(popupContent);
                                markers.addLayer(marker);
                            }
                        });
                        mymap.addLayer(markers);
                    });
            }

            document.getElementById('name').addEventListener('change', function () {
                var name = document.getElementById('name').value;
                if (name === 'inSeason') {
                    document.getElementById('dateContainer').classList.add('flex');
                } else {
                    document.getElementById('dateContainer').classList.remove('flex');
                }
                loadVisibleTrees();
            });
            document.getElementById('seasonSlider').addEventListener('change', loadVisibleTrees);

            var geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: "Search for an address...",
                collapsed: false,
                position: 'topright',
                geocoder: new L.Control.Geocoder.Nominatim()
            }).on('markgeocode', function (e) {
                var bbox = e.geocode.bbox;
                var center = e.geocode.center;

                var currentMarker = L.marker(center).addTo(mymap)
                    .bindPopup(e.geocode.name)
                    .openPopup();

                var poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]).addTo(mymap);
                mymap.fitBounds(poly.getBounds());
            }).addTo(mymap);

            mymap.on('moveend', loadVisibleTrees);
            mymap.on('zoomend', loadVisibleTrees);

            loadVisibleTrees();
        });
    </script>

    <img src="MulberryAdventure.png" alt="Mulberry Adventure">

    <p>A site to find fruit trees in Toronto based on the Street Tree Data provided by the City of Toronto:
        <a href="https://open.toronto.ca/dataset/street-tree-data/"
            target="_blank">https://open.toronto.ca/dataset/street-tree-data/</a>
    </p>

    <p>Inspired by: <a href="https://www.mapto.ca/maps/the-fruit-trees-of-toronto/"
            target="_blank">https://www.mapto.ca/maps/the-fruit-trees-of-toronto/</a> and <a
            href="https://notfarfromthetree.org/" target="_blank">https://notfarfromthetree.org/</a></p>

    <p>Mulberries are delicious.</p>
</body>

</html>